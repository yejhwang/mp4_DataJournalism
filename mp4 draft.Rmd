---
title: "The Rebirth of Westerns or their Death?"
author: "Yejin Hwang"
date: "12/3/2017"
output: 
  html_document:
    code_folding: hide
---
![3 cowboy image address](https://cdn1.thr.com/sites/default/files/imagecache/landscape_928x523/2015/07/becoming_bulletproof_still_h_15.jpg)
![stereotyped ways to die in west image address](http://forumcinemaslv.blob.core.windows.net/1012/Event_7446/landscape_large/millionways_670.jpg)
![logan a western?](https://vignette.wikia.nocookie.net/xmenmovies/images/7/7c/Caliban_%26_Logan_%28Mexico%29.png/revision/latest?cb=20170518092739)
Genres: Action | Drama | Sci-Fi | Thriller
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(mdsr)
library(RMySQL)
db <- dbConnect_scidb(dbname = "imdb")
library(tidyverse)
library(dplyr)
library(ggplot2)
library(plotly)
```

```{r, eval=FALSE}
withRating <- db %>%
  dbGetQuery("SELECT t.title, t.production_year, mi1.info  AS genre, mi2.info AS Rating
FROM title t
JOIN movie_info mi1 ON mi1.movie_id = t.id
JOIN movie_info_idx mi2 ON mi2.movie_id = t.id
LEFT JOIN movie_info mi3 ON mi3.movie_id = t.id
LEFT JOIN movie_info mi4 ON mi4.movie_id = t.id
LEFT JOIN movie_info_idx mii ON mii.movie_id = t.id
WHERE t.kind_id = 1
AND mi1.info_type_id = 3
AND mi2.info_type_id = 101 
AND mi3.info_type_id = 8 AND mi3.info = 'USA'
AND mi4.info_type_id = 1 AND mi4.info > 40
AND mii.info_type_id = 100 AND mii.info> 500
AND t.production_year BETWEEN 1900 AND 2016;")

#============= Data focusing on number of Westerns over the years ===============
withRating <- withRating %>%
  mutate(isWest = ifelse(genre == 'Western',TRUE,FALSE))
westM <- withRating %>%
  filter(isWest == TRUE)
numWest <- westM %>%
  group_by(production_year) %>%
  summarise(NW = n())
#============= Saving dataframe with percentage of Westerns over all films ======
numM <- withRating %>%
  group_by(title, production_year) %>%
  do(head(.,n=1)) %>%
  group_by(production_year) %>%
  summarise(N = n())
perWest <- numM %>%
  left_join(numWest, by = c("production_year"="production_year")) %>%
  mutate(percentage = NW/N*100)
#============= Saving dataframe with averaged ratings by year ====================
ratings <- westM %>%
  mutate(Rating = parse_number(Rating)) %>%
  group_by(production_year) %>%
  summarise(mean = mean(Rating), n = n())
```
```{r}
#mean rating
#efficient SQL queries: making use of an index column with t.kind_id = 1
#t.kind_id = 1 specifies for only Movies rather than TV shows or TV movies
#AND mi3.info = 'USA'
# AND mii.info> 500
save(perWest,file="perWest.rda")
save(westM, file="westM.rda")
```
```{r,echo=FALSE}
load("perWest.rda")
load("westM.rda")
```


```{r,eval=FALSE}

keyShifts <- db%>%dbGetQuery("SELECT production_year, keyword, COUNT(DISTINCT t.id) as count
FROM title t
JOIN movie_info mi1 ON mi1.movie_id = t.id
JOIN movie_info mi2 ON mi2.movie_id = t.id
LEFT JOIN movie_info mi3 ON mi3.movie_id = t.id
LEFT JOIN movie_info mi4 ON mi4.movie_id = t.id
LEFT JOIN movie_info_idx mii ON mii.movie_id = t.id
JOIN movie_keyword mk ON t.id = mk.movie_id
JOIN keyword k ON k.id=mk.keyword_id
WHERE t.kind_id = 1
AND mi1.info_type_id = 3 AND mi1.info = 'Western'
AND mi3.info_type_id = 8 AND mi3.info = 'USA'
AND mi4.info_type_id = 1 AND mi4.info > 40
AND mii.info_type_id = 100 AND mii.info> 500
AND production_year BETWEEN 1900 AND 2016
AND (k.keyword LIKE '%indians%' OR k.keyword LIKE '%anti-hero%' OR k.keyword LIKE '%supernatural%')
GROUP BY production_year, keyword;
")
```
```{r}
byKeyword <- keyShifts %>%
  mutate(indian = ifelse(grepl("indian", x = keyword),count,0),antihero = ifelse(grepl("anti-hero", x = keyword),count,0),supernatural = ifelse(grepl("supernatural", x = keyword),count,0))

numKeyword <- byKeyword %>%
  select(production_year, indian, antihero, supernatural) %>%
  group_by(production_year) %>%
  summarise(indian = sum(indian),antihero = sum(antihero),supernatural = sum(supernatural)) %>%
  gather(Keywords, Count, -production_year) %>%
  filter(Count!=0)
```
('cowboys-and-indians', 'anti-hero','anti-heroine')
cowboys-and-indians
anti-hero (ine)
AND mi.info LIKE '%NC-17%'
indians
supernatural
anti-hero

```{r}
ggplot(numKeyword, aes(x=production_year, y = Count,fill = Keywords))+
  geom_bar(width=0.8, position = position_dodge(width=0.6), stat="identity") 

ggplot(numKeyword, aes(x=production_year, y = Count,fill = Keywords))+
  geom_area(position = "stack") 

ggplot(ratings, aes(x = production_year, y = mean))+
  geom_point() +
  geom_smooth()
```
```{r}
maxRat <- ratings %>%
  arrange(mean)
```
FilL <- c("#232066", "#E91D0E")
    scale_fill_manual(values=FilL, name = "Candidate Party\n   Affiliation") +

```{r, message=FALSE,echo=FALSE,warning=FALSE}
graphP <- ggplot(perWest,aes(x = production_year, y = percentage)) + 
  #geom_rect(xmin=1980,xmax=2015, ymin=-Inf, ymax=Inf, fill="grey",alpha=0.05)+
  geom_point(data = ratings, aes(x = production_year, y = mean)) +
  geom_smooth(color = "red", se=FALSE) +
  geom_smooth(aes(x = production_year, y=NW),color = "orange" , se=FALSE) + 
  labs(x = "Production Year", y="Percentage of Western Movies (%)") + 
  scale_y_continuous(expand=c(0.03,0),breaks=seq(0,25,5), labels = c("0%","5%","10%","15%","20%","25%"),sec.axis = sec_axis(~.*1, name = "Number of Western Movies",breaks=seq(0,25,5)))+ 
  theme(axis.title.y = element_text(colour = "red"),axis.text.y = element_text(color = "red"), axis.text.y.right = element_text(color = "orange"),axis.title.y.right = element_text(colour = "orange"))+
  geom_bar(data = numKeyword, aes(x=production_year, y = Count,fill = Keywords),width=0.8, position = position_dodge(width=0.6), stat="identity")

graphP
```

```{r}
p <- ggplotly(graphP)
p
```

[GitHub repository link](https://github.com/yejhwang/mp4_DataJournalism.git)


