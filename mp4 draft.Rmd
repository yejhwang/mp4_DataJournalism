---
title: "The Rebirth of Westerns or their Death?"
author: "Yejin Hwang"
date: "12/3/2017"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(mdsr)
library(RMySQL)
db <- dbConnect_scidb(dbname = "imdb")
library(tidyverse)
library(dplyr)
library(ggplot2)
```

```{r, eval=FALSE}
specgenre <- db %>%
  dbGetQuery("SELECT title, production_year, mi1.info  AS genre,mi4.info AS Runtime, mii.info AS Votes
FROM title t
JOIN movie_info mi1 ON mi1.movie_id = t.id
JOIN movie_info mi2 ON mi2.movie_id = t.id
LEFT JOIN movie_info mi3 ON mi3.movie_id = t.id
LEFT JOIN movie_info mi4 ON mi4.movie_id = t.id
LEFT JOIN movie_info_idx mii ON mii.movie_id = t.id
WHERE t.kind_id = 1
AND mi1.info_type_id = 3
AND mi3.info_type_id = 8 AND mi3.info = 'USA'
AND mi4.info_type_id = 1 AND mi4.info > 40
AND mii.info_type_id = 100 AND mii.info> 500
AND production_year BETWEEN 1900 AND 2016;
")
#efficient SQL queries: making use of an index column with t.kind_id = 1
#t.kind_id = 1 specifies for only Movies rather than TV shows or TV movies
#AND mi3.info = 'USA'
# AND mii.info> 500
#============= Saving dataframe with percentage of Westerns over all films =======
specgenre <- specgenre %>%
  mutate(isWest = ifelse(genre == 'Western',TRUE,FALSE))
westM <- specgenre %>%
  filter(isWest == TRUE)
numM <- genreBudget %>%
  group_by(title, production_year) %>%
  do(head(.,n=1))
numM2 <- numM %>%
  group_by(production_year) %>%
  summarise(N = n())
numWest <- westM %>%
  group_by(production_year) %>%
  summarise(NW = n())
perWest <- numM2 %>%
  left_join(numWest, by = c("production_year"="production_year")) %>%
  mutate(percentage = NW/N*100)
```
```{r}
save(perWest,file="perWest.rda")
save(westM, file="westM.rda")

#geom_point(x=2015, y=110,shape=21, fill="white")+
  #annotate("text", x = 2005, y = 105, label = "110 Westerns\nin 2015",colour = "navy", size = 3,family = "PT Sans") +
```
```{r,echo=FALSE}
load("perWest.rda")
load("westM.rda")
```


```{r}
graphC <- ggplot(perWest,aes(x = production_year, y = percentage)) + 
  #geom_rect(xmin=1980,xmax=2015, ymin=-Inf, ymax=Inf, fill="grey",alpha=0.05)+
  geom_smooth(color = "red") +
  geom_smooth(aes(x = production_year, y=NW),color = "orange") + 
  labs(x = "Production Year", y="Percentage of Western Movies (%)") + 
  scale_y_continuous(expand=c(0.03,0),breaks=seq(0,90,30), labels = c("0%","30%","60%","90%"),sec.axis = sec_axis(~.*1, name = "Number of Western Movies"))+ 
  theme(axis.title.y = element_text(colour = "red"),axis.text.y = element_text(color = "red"), axis.text.y.right = element_text(color = "orange"),axis.title.y.right = element_text(colour = "orange"))
```
##Percentage and Number of Western Films Over Time
```{r, message=FALSE,echo=FALSE,warning=FALSE}
graphC
```
```{r,eval=FALSE}

keyShifts <- db%>%dbGetQuery("SELECT production_year, keyword, COUNT(DISTINCT t.id) as count
FROM title t
JOIN movie_info mi1 ON mi1.movie_id = t.id
JOIN movie_info mi2 ON mi2.movie_id = t.id
LEFT JOIN movie_info mi3 ON mi3.movie_id = t.id
LEFT JOIN movie_info mi4 ON mi4.movie_id = t.id
LEFT JOIN movie_info_idx mii ON mii.movie_id = t.id
JOIN movie_keyword mk ON t.id = mk.movie_id
JOIN keyword k ON k.id=mk.keyword_id
WHERE t.kind_id = 1
AND mi1.info_type_id = 3 AND mi1.info = 'Western'
AND mi3.info_type_id = 8 AND mi3.info = 'USA'
AND mi4.info_type_id = 1 AND mi4.info > 40
AND mii.info_type_id = 100 AND mii.info> 500
AND production_year BETWEEN 1900 AND 2016
AND k.keyword IN ('cowboys-and-indians', 'anti-hero','anti-heroine')
GROUP BY production_year, keyword;
")
```
cowboys-and-indians
anti-hero (ine)
```{r}
#twoKey <- keyShifts %>%
  #mutate(ifelse(keyword = c('anti-hero','anti-heroine'),))
```
```{r}
save(keyShifts, file="keyShifts.rda")
load("keyShifts.rda")
```
```{r}
ggplot(keyShifts, aes(x=production_year, y = count,fill = keyword))+
  geom_bar(width=0.8, position = position_dodge(width=0.6), stat="identity") 
```
FilL <- c("#232066", "#E91D0E")
    scale_fill_manual(values=FilL, name = "Candidate Party\n   Affiliation") +

```{r,message=FALSE,error=FALSE}
graphC +
  geom_bar(data = keyShifts, aes(x=production_year, y = count,fill = keyword),width=0.8, position = position_dodge(width=0.6), stat="identity")
```

[GitHub repository link](https://github.com/yejhwang/mp4_DataJournalism.git)


